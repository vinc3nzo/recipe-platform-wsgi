# О проекте
Целью проекта было создание тренировочного приложения, бэкенда для
платформы по обмену кулинарными рецептами.

Реализованы три полномочия:
1. *Пользователь*. Имеет возможность загружать рецепты (формат Markdown),
просматривать рецепты других пользователей, добавлять их в закладки
и ставить рейтинг. Также есть простая система тэгов, по которым
можно производить поиск.
Когда пользователь добавляет новый рецепт, он переходит в состояние
ожидания проверки. Рецепт в таком состоянии может быть просмотрен
только автором или человеком, который знает его ID.
2. *Модератор*. Может изменять состояние рецепта. Рецепт
либо отклоняется, либо одобряется. Одобренные рецепты могут
быть видны всем авторизованным пользователям платформы.
3. *Администратор*. Может назначать модераторов. Подписанный JWT администратора
выводится в лог при запуске приложения и может быть использован.

Пользовательский Markdown никак не очищается. Сразу после получения рецепта
фронтенд должен воспользоваться санитайзером во избежание XSS-атак.

Схема базы данных расположена в корне репозитория (`RecipePlatform.png`).

Экспорт сгенерированной Swagger'ом OpenAPI спецификации также
размещен в корне репозитория (`openapi.json`). После запуска
приложения Swagger-документация доступна на `/apidoc/swagger`.

# Быстрый старт
Для работы приложения требуется Python 3.10 или новее, а также
установленный Docker.

## Подготовка приложения
Клонируйте репозиторий и перейдите в корень:
```bash
git clone git@github.com:vinc3nzo/recipe-platform-wsgi.git
cd recipe-platform-wsgi
```

Создайте и активируйте виртуальную среду Python:
```bash
python -m venv ./.venv
source ./.venv/bin/activate
```
или если используете Windows PowerShell:
```powershell
python -m venv .\.venv
Set-ExecutionPolicy -Scope Process Bypass
.\.venv\Scripts\activate.ps1
```

Установите зависимости:
```bash
pip install -r requirements.txt
```

Если в ходе установки возникает ошибка, связанная с методом установки
пакета `psycopg2`, установите его отдельно командой:
```bash
pip install --use-pep517 "psycopg2>=2.9.5"
```
и затем удалите эту строку из `requirements.txt` и повторите установку
зависимостей.

В корне репозитория создайте файл `.env` со следующим содержанием:
```properties
RECIPE_APP_SECRET=your_app_secret
RECIPE_DATABASE_PASSWORD=your_database_password
```
Настоятельно рекомендуется заменить значения переменных на другие.

## Подготовка базы данных
В качестве базы данных будет использоваться PostgreSQL внутри Docker-контейнера.
Выполните следующую команду. Она загрузит образ `postgres` и запустит новый
Docker-контейнер со всеми необходимыми настройками:
```bash
docker run \
    -p 5432:5432 \
    -e POSTGRES_PASSWORD=your_database_password \
    -d \
    --name recipe-postgres \
    postgres
```
или если используете Windows PowerShell (убедитесь, что Docker Desktop запущен
и daemon активен):
```powershell
docker run `
    -p 5432:5432 `
    -e POSTGRES_PASSWORD=your_database_password `
    -d `
    --name recipe-postgres `
    postgres
```

Убедитесь, что контейнер запустился:
```bash
docker container ls
```

Далее инициализируйте базу данных и создайте схему. Скрипт
`alembic/env.py` уже изменен таким образом, чтобы создать базу
данных при ее отсутствии. Чтобы создать схему, выполните команду
(выполнять ее нужно в активированной виртуальной среде Python)
```bash
alembic revision --autogenerate -m "Create database schema"
```

Примените созданную миграцию:
```bash
alembic upgrade head
```

После выполнения этих шагов приложение готово к запуску.

## Запуск приложения
Чтобы запустить приложение, в активной виртуальной среде Python
выполните команду
```bash
gunicorn 'recipe.app:app'
```
Взаимодействие с приложением по умолчанию осуществляется через
порт `8000`. Автоматически сгенерированная Swagger-документация доступна
по адресу `localhost:8000/apidoc/swagger`.

# Тонкая настройка
У приложения существует ряд параметров, которые возможно задавать
при помощи переменных окружения. Большинство из них не являются
обязательными и если их не установить, то будут использованы
значения по умолчанию.

- `RECIPE_APP_SECRET` **обязательно** -- секретный ключ приложения. Используется
для подписи JWT и является ключевым элементом безопасности приложения.
- `RECIPE_DATABASE_PASSWORD` **обязательно** -- пароль пользователя базы данных. Используется вместе с именем пользователя.
- `RECIPE_DATABASE_USER` -- имя пользователя базы данных. Используется вместе с паролем пользователя (по умолчанию `postgres`).
- `RECIPE_DATABASE_NAME` -- название базы данных (по умолчанию `recipe-wsgi`).
- `RECIPE_DATABASE_HOST`, `RECIPE_DATABASE_PORT` -- хост и порт, на которых
база данных слушает запросы.